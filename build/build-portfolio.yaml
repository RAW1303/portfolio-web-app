name: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
- master
- develop
- feature/*

pr:
- develop

pool:
    vmImage: 'ubuntu-16.04'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'

- task: Npm@1
  inputs:
    command: 'custom'
    customCommand: 'install -g @angular/cli'
  displayName: 'Install Angular CLI'

- task: Npm@1
  inputs:
    command: 'custom'
    customCommand: 'ci'
    customRegistry: 'useFeed'
    customFeed: 'fad0022c-8dae-4f58-8008-b0bfd3e3128c'
  displayName: 'Resolve Dependencies'

- task: Npm@1
  inputs:
    command: 'custom'
    customCommand: 'test'
  displayName: 'Test'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test/results.xml' 
    testRunTitle: $(Build.BuildNumber)
  displayName: 'Publish Test Results'

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'cobertura'
    summaryFileLocation: 'test/coverage.xml'
    failIfCoverageEmpty: true
  displayName: 'Publish Coverage'

- task: Npm@1
  inputs:
    command: 'custom'
    customCommand: 'run build-prod'
  displayName: 'Build'

- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: '$(System.DefaultWorkingDirectory)/dist' 
    artifactName: 'app' 
    parallel: true 
    parallelCount: 8
  displayName: 'Publish Artifacts'
